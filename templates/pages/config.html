{% extends 'base.html' %}
{% load static %}
{% load _extras %}

{% block title %}
{{ ""|replace_dashes:field_name|title }}
{% endblock %}

{% block content %}

<h1 class="text-center config-header">{{ ""|replace_dashes:field_name|title }}</h1>
<hr>
<!-- Basic -->
<table class="table table-striped table-bordered">
    <tbody>
        {% for k, v in field_data.items %}
        <!-- Replace with slugify I believe -->
            {% with "tr-"|addstr:k as dynamic_id %}
                <tr class="config-row">
                    <td style="width: 70%" ><input type="text" class="item-input no-border border-bottom inherit-bg-color" placeholder="Edit Me!" value="{{ k }}"></input></td>
                    <td class="text-center d-flex justify-content-center">
                        <ul class="pagination">
                            {% for i in "12345"|make_list %}
                                <li class="page-item {% if i == ''|addstr:v  %} active {% endif %}"><p class="page-link" href="#">{{ i }}</p></li>
                            {% endfor %}
                        </ul>
                    </td>
                    <td style="width: 10%"><a href="#" class="btn btn-secondary btn-delete active d-flex justify-content-center" role="button" aria-pressed="true">Delete</a></td>
                </tr>
            {% endwith %}
        {% endfor %}
    </tbody>
</table>
<div class="row">
    <div class="col-10">
        <button class="btn btn-primary btn-green btn-block" id="button-add-rows">+</button>
    </div>
    <div class="col-2">
        <label for="how-many-to-add">Add this many new rows.</label>
        <input type="text" id="how-many-to-add" class="no-border border-bottom text-center" placeholder=1>
    </div>
</div>
<div class="row last-row">
    <div class="col-6">
        <!-- <form action="{% url 'field:save-changes' field_name %}" method="GET">
            {% csrf_token %} -->
            <button class="btn btn-lg btn-block btn-green" id="button-save" aria-pressed="true">Save Changes</a>
        <!-- </form> -->
    </div>
    <div class="col-6">
        <button class="btn btn-lg btn-block btn-grey" id="button-delete-all" aria-pressed="true">Delete All</a>
    </div>
</div>

<!-- Eventually I want to remove this call to jQuery, since I think it should only be done in base.html.  -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>

<script>
    // This is used for letting the Python backend know which field names need updating.

    $(document).on("click", "#button-delete-all", function() {
        $(".config-row").remove()
        return false
    })
    $(document).on("click", ".btn-delete", function() {
        $(this).parent().parent().remove()
        return false
    })
    $(document).on("click", "li", function() {
        LIs = $(this).parent().children()
        for (i = 0; i < LIs.length; i++){
            LIs[i].classList.remove("active")
        }
        $(this).addClass("active")
        return false
    })
    $("#save-button").on("click", function(){
        configRows = $('.config-row')
        newConfigData = {}
        for (i=0; i < configRows.length; i++){
            key = configRows[i].children[0].children[0].value
            value = 3
            for (j=0; j < configRows[i].children[1].children[0].children.length; j++){
                if (configRows[i].children[1].children[0].children[j].className.includes("active")){
                    value = j+1
                }
            }
            newConfigData[key] = value
        }
        jsonString = JSON.stringify(newConfigData)
        $.ajax({
            type: "POST",
            url: "{% url 'field:save-changes' field_name %}",
            data: {
                "field_data": jsonString,
            }
        })
    })

    $("#button-add-rows").on("click", function() {
        howMany = $("#how-many-to-add")
        numRowsToAdd = howMany.val() != "" ? parseInt(howMany.val()) : 1;
        tbody = $('tbody')
        for (i=0; i < numRowsToAdd; i++) {
        tbody.append(`
                <tr class="config-row">
                    <td style="width: 70%"><input type="text" class="item-input no-border border-bottom inherit-bg-color" placeholder="Edit Me!"></input></td>
                    <td class="text-center d-flex justify-content-center">
                        <ul class="pagination">
                            {% for i in "12345"|make_list %}
                                <li class="page-item {% if i == '3'  %} active {% endif %}"><p class="page-link" href="#">{{ i }}</p></li>
                            {% endfor %}
                        </ul>
                    </td>
                    <td style="width: 10%"><a href="#" class="btn btn-secondary btn-delete active d-flex justify-content-center" role="button" aria-pressed="true">Delete</a></td>
                </tr>
            `)
        }
    });

    function addItem(){
        $('tbody').append(`
            <tr class="config-row">
                <td style="width: 70%"><input type="text" class="item-input no-border border-bottom inherit-bg-color" placeholder="Edit Me!"></input></td>
                <td class="text-center d-flex justify-content-center">
                    <ul class="pagination">
                        {% for i in "12345"|make_list %}
                            <li class="page-item {% if i == '3'  %} active {% endif %}"><p class="page-link" href="#">{{ i }}</p></li>
                        {% endfor %}
                    </ul>
                </td>
                <td style="width: 10%"><a href="#" class="btn btn-secondary btn-delete active d-flex justify-content-center" role="button" aria-pressed="true">Delete</a></td>
            </tr>
        `)
    }

</script>

{% endblock %}
