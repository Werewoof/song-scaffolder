{% extends 'base.html' %}
{% load static %}
{% load _extras %}

{% block title %}
{{ ""|replace_dashes:field_name|title }}
{% endblock %}

{% block content %}

<h1 class="text-center config-header">{{ ""|replace_dashes:field_name|title }}</h1>
<hr>
<!-- Basic -->
{% if depth == 1 %}
    <table class="table table-striped table-bordered">
        <tbody>
            {% for k, v in field_data.items %}
            <!-- Replace with slugify I believe -->
                {% with "tr-"|addstr:k as dynamic_id %}
                    <tr class="config-row">
                        <td style="width: 70%" ><input type="text" class="item-input no-border border-bottom inherit-bg-color" placeholder="Edit Me!" value="{{ k }}"></input></td>
                        <td class="text-center d-flex justify-content-center">
                            <ul class="pagination">
                                {% for i in "12345"|make_list %}
                                    <li class="page-item {% if i == ''|addstr:v  %} active {% endif %}"><p class="page-link" href="#">{{ i }}</p></li>
                                {% endfor %}
                            </ul>
                        </td>
                        <td style="width: 10%"><a href="#" class="btn btn-secondary btn-delete active d-flex justify-content-center" role="button" aria-pressed="true">Delete</a></td>
                    </tr>
                {% endwith %}
            {% endfor %}
        </tbody>
    </table>
    <button class="btn btn-primary btn-green btn-block" onclick="addItem('{{ field_name }}')">+</button>

<!-- Time Signatures -->
{% elif depth == 2 %}
    {% for k, v in field_data.items %}
        <div class="row" id="{{ dynamic_id }}">
            <div class="col-12 first-col">{{ k }}</div>
            {% for k_1, v_1 in v.items %}
                <div class="col-8 first-col nested-config-1">{{ k_1 }}</div>
                <div class="col-4 second-col d-flex justify-content-center"><p class="get-help text-center" id="get-help-for-quantity">{{ v_1 }}</p></div>
            {% endfor %}
        </div>
    {% endfor %}
{% endif %}

<div class="row last-row">
    <div class="col-2">
    </div>
    <div class="col-8">
        <!-- <form action="{% url 'field:save-changes' field_name %}" method="GET">
            {% csrf_token %} -->
            <button class="btn btn-lg btn-block btn-green" id="save-button" aria-pressed="true">Save Changes</a>
        <!-- </form> -->
    </div>
    <div class="col-2">
    </div>
</div>

<!-- Eventually I want to remove this call to jQuery, since I think it should only be done in base.html.  -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>

<script>
    // This is used for letting the Python backend know which field names need updating.

    $(document).on("click", ".btn-delete", function() {
        $(this).parent().parent().remove()
        return false
    })
    $(document).on("click", "li", function() {
        LIs = $(this).parent().children()
        for (i = 0; i < LIs.length; i++){
            LIs[i].classList.remove("active")
        }
        $(this).addClass("active")
        return false
    })
    $("#save-button").on("click", function(){
        configRows = $('.config-row')
        newConfigData = {}
        for (i=0; i < configRows.length; i++){
            key = configRows[i].children[0].children[0].value
            value = 3
            for (j=0; j < configRows[i].children[1].children[0].children.length; j++){
                if (configRows[i].children[1].children[0].children[j].className.includes("active")){
                    value = j+1
                }
            }
            newConfigData[key] = value
        }
        jsonString = JSON.stringify(newConfigData)
        $.ajax({
            type: "POST",
            url: "{% url 'field:save-changes' field_name %}",
            data: {
                "field_data": jsonString,
            }
        })
    })

    function addItem(){
        $('tbody').append(`
            <tr class="config-row">
                <td style="width: 70%"><input type="text" class="item-input no-border border-bottom inherit-bg-color" placeholder="Edit Me!"></input></td>
                <td class="text-center d-flex justify-content-center">
                    <ul class="pagination">
                        {% for i in "12345"|make_list %}
                            <li class="page-item {% if i == '3'  %} active {% endif %}"><p class="page-link" href="#">{{ i }}</p></li>
                        {% endfor %}
                    </ul>
                </td>
                <td style="width: 10%"><a href="#" class="btn btn-secondary btn-delete active d-flex justify-content-center" role="button" aria-pressed="true">Delete</a></td>
            </tr>
        `)
    }

</script>

{% endblock %}
